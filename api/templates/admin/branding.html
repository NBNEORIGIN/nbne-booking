{% extends "base.html" %}

{% block title %}Branding Settings{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Branding Settings</h1>
        <p class="text-gray-600 mt-2">Customize how your booking page appears to customers</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Edit Form -->
        <div class="space-y-6">
            <form id="brandingForm" class="space-y-6">
                <!-- Display Name -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Basic Information</h2>
                    
                    <div class="mb-4">
                        <label for="client_display_name" class="block text-sm font-medium text-gray-700 mb-2">
                            Display Name
                        </label>
                        <input type="text" id="client_display_name" name="client_display_name" 
                               value="{{ tenant.client_display_name or tenant.name }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Your Business Name">
                        <p class="text-xs text-gray-500 mt-1">This appears in the header of your booking page</p>
                    </div>

                    <div class="mb-4">
                        <label for="logo_url" class="block text-sm font-medium text-gray-700 mb-2">
                            Logo URL
                        </label>
                        <input type="url" id="logo_url" name="logo_url" 
                               value="{{ tenant.logo_url or '' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="https://example.com/logo.png">
                        <p class="text-xs text-gray-500 mt-1">Optional: URL to your logo image</p>
                    </div>
                </div>

                <!-- Colors -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Brand Colors</h2>
                    
                    <div class="mb-4">
                        <label for="primary_color" class="block text-sm font-medium text-gray-700 mb-2">
                            Primary Color
                        </label>
                        <div class="flex gap-2">
                            <input type="color" id="primary_color" name="primary_color" 
                                   value="{{ tenant.primary_color or '#2196F3' }}"
                                   class="h-10 w-20 border border-gray-300 rounded cursor-pointer">
                            <input type="text" id="primary_color_text" 
                                   value="{{ tenant.primary_color or '#2196F3' }}"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="#2196F3" pattern="^#[0-9A-Fa-f]{6}$">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Main brand color (header, buttons)</p>
                    </div>

                    <div class="mb-4">
                        <label for="secondary_color" class="block text-sm font-medium text-gray-700 mb-2">
                            Secondary Color (Optional)
                        </label>
                        <div class="flex gap-2">
                            <input type="color" id="secondary_color" name="secondary_color" 
                                   value="{{ tenant.secondary_color or '#1976D2' }}"
                                   class="h-10 w-20 border border-gray-300 rounded cursor-pointer">
                            <input type="text" id="secondary_color_text" 
                                   value="{{ tenant.secondary_color or '#1976D2' }}"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="#1976D2" pattern="^#[0-9A-Fa-f]{6}$">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Auto-generated if not set</p>
                    </div>

                    <div class="mb-4">
                        <label for="accent_color" class="block text-sm font-medium text-gray-700 mb-2">
                            Accent Color (Optional)
                        </label>
                        <div class="flex gap-2">
                            <input type="color" id="accent_color" name="accent_color" 
                                   value="{{ tenant.accent_color or '#4CAF50' }}"
                                   class="h-10 w-20 border border-gray-300 rounded cursor-pointer">
                            <input type="text" id="accent_color_text" 
                                   value="{{ tenant.accent_color or '#4CAF50' }}"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="#4CAF50" pattern="^#[0-9A-Fa-f]{6}$">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Used for CTAs and highlights</p>
                    </div>
                </div>

                <!-- Booking Page Content -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Booking Page Content</h2>
                    
                    <div class="mb-4">
                        <label for="booking_page_title" class="block text-sm font-medium text-gray-700 mb-2">
                            Page Title
                        </label>
                        <input type="text" id="booking_page_title" name="booking_page_title" 
                               value="{{ tenant.booking_page_title or 'Book Your Appointment' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="Book Your Appointment">
                    </div>

                    <div class="mb-4">
                        <label for="booking_page_intro" class="block text-sm font-medium text-gray-700 mb-2">
                            Welcome Message
                        </label>
                        <textarea id="booking_page_intro" name="booking_page_intro" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="Welcome! Select a service and time that works for you.">{{ tenant.booking_page_intro or '' }}</textarea>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Contact Information</h2>
                    
                    <div class="mb-4">
                        <label for="location_text" class="block text-sm font-medium text-gray-700 mb-2">
                            Location
                        </label>
                        <input type="text" id="location_text" name="location_text" 
                               value="{{ tenant.location_text or '' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="London, UK">
                    </div>

                    <div class="mb-4">
                        <label for="contact_email" class="block text-sm font-medium text-gray-700 mb-2">
                            Contact Email
                        </label>
                        <input type="email" id="contact_email" name="contact_email" 
                               value="{{ tenant.contact_email or tenant.email }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="contact@example.com">
                    </div>

                    <div class="mb-4">
                        <label for="contact_phone" class="block text-sm font-medium text-gray-700 mb-2">
                            Contact Phone
                        </label>
                        <input type="tel" id="contact_phone" name="contact_phone" 
                               value="{{ tenant.contact_phone or tenant.phone }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="+44 20 1234 5678">
                    </div>

                    <div class="mb-4">
                        <label for="business_address" class="block text-sm font-medium text-gray-700 mb-2">
                            Business Address
                        </label>
                        <textarea id="business_address" name="business_address" rows="2"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  placeholder="123 Main Street, London, UK">{{ tenant.business_address or '' }}</textarea>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-4">
                    <button type="submit" id="saveBtn"
                            class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Save Changes
                    </button>
                    <button type="button" onclick="resetForm()"
                            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50 transition-colors">
                        Reset
                    </button>
                </div>

                <div id="message" class="hidden"></div>
            </form>
        </div>

        <!-- Live Preview -->
        <div class="lg:sticky lg:top-4 lg:self-start">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">Live Preview</h2>
                    <a href="/public/preview" target="_blank" 
                       class="text-sm text-blue-600 hover:text-blue-800">
                        Open Full Preview →
                    </a>
                </div>
                
                <div id="preview" class="border-2 border-gray-200 rounded-lg overflow-hidden">
                    <!-- Preview will be rendered here -->
                    <div id="previewHeader" class="p-6 text-white transition-colors duration-300">
                        <h1 id="previewName" class="text-2xl font-bold">{{ tenant.client_display_name or tenant.name }}</h1>
                        <div id="previewLocation" class="mt-2 text-sm opacity-90">
                            {{ tenant.location_text or 'Your Location' }}
                        </div>
                    </div>
                    
                    <div class="p-6 bg-gray-50">
                        <div class="bg-white rounded-lg p-4 mb-4">
                            <p id="previewIntro" class="text-gray-700">
                                {{ tenant.booking_page_intro or 'Your welcome message will appear here.' }}
                            </p>
                        </div>
                        
                        <div class="space-y-3">
                            <button id="previewPrimaryBtn" class="w-full px-4 py-2 rounded-lg font-semibold transition-colors">
                                Primary Button
                            </button>
                            <button id="previewAccentBtn" class="w-full px-4 py-2 rounded-lg font-semibold transition-colors">
                                Accent Button
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Sync color pickers with text inputs
['primary', 'secondary', 'accent'].forEach(color => {
    const picker = document.getElementById(`${color}_color`);
    const text = document.getElementById(`${color}_color_text`);
    
    picker.addEventListener('input', (e) => {
        text.value = e.target.value.toUpperCase();
        updatePreview();
    });
    
    text.addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
            picker.value = e.target.value;
            updatePreview();
        }
    });
});

// Update preview on any input change
document.querySelectorAll('#brandingForm input, #brandingForm textarea').forEach(input => {
    input.addEventListener('input', updatePreview);
});

function updatePreview() {
    const formData = new FormData(document.getElementById('brandingForm'));
    
    // Update header
    const primaryColor = formData.get('primary_color') || '#2196F3';
    const previewHeader = document.getElementById('previewHeader');
    previewHeader.style.backgroundColor = primaryColor;
    
    // Calculate text color for contrast
    const textColor = getContrastColor(primaryColor);
    previewHeader.style.color = textColor;
    
    // Update name
    document.getElementById('previewName').textContent = 
        formData.get('client_display_name') || 'Your Business Name';
    
    // Update location
    const location = formData.get('location_text');
    document.getElementById('previewLocation').textContent = location || 'Your Location';
    document.getElementById('previewLocation').style.display = location ? 'block' : 'none';
    
    // Update intro
    document.getElementById('previewIntro').textContent = 
        formData.get('booking_page_intro') || 'Your welcome message will appear here.';
    
    // Update buttons
    const accentColor = formData.get('accent_color') || '#4CAF50';
    const primaryBtn = document.getElementById('previewPrimaryBtn');
    const accentBtn = document.getElementById('previewAccentBtn');
    
    primaryBtn.style.backgroundColor = primaryColor;
    primaryBtn.style.color = textColor;
    
    accentBtn.style.backgroundColor = accentColor;
    accentBtn.style.color = getContrastColor(accentColor);
}

function getContrastColor(hexColor) {
    // Convert hex to RGB
    const r = parseInt(hexColor.substr(1, 2), 16);
    const g = parseInt(hexColor.substr(3, 2), 16);
    const b = parseInt(hexColor.substr(5, 2), 16);
    
    // Calculate relative luminance
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Return black or white based on luminance
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

function resetForm() {
    document.getElementById('brandingForm').reset();
    updatePreview();
}

// Form submission
document.getElementById('brandingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const saveBtn = document.getElementById('saveBtn');
    const message = document.getElementById('message');
    
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    message.classList.add('hidden');
    
    try {
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        const response = await fetch('/api/v1/tenants/{{ tenant.id }}', {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error('Failed to save branding settings');
        }
        
        message.textContent = '✓ Branding settings saved successfully!';
        message.className = 'p-4 bg-green-50 border-l-4 border-green-500 text-green-800 rounded';
        message.classList.remove('hidden');
        
        setTimeout(() => {
            message.classList.add('hidden');
        }, 5000);
        
    } catch (error) {
        console.error('Save error:', error);
        message.textContent = '✗ Failed to save branding settings. Please try again.';
        message.className = 'p-4 bg-red-50 border-l-4 border-red-500 text-red-800 rounded';
        message.classList.remove('hidden');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
    }
});

// Initial preview update
updatePreview();
</script>
{% endblock %}
